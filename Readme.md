# API service for sending notifications

### Запуск через Docker-compose
1. Склонировать репозиторий.
2. По желанию поменять переменные в .env файле (переменные API_ADRESS, DB_SERVICE рекомендуется не изменять).
3. По желанию можно изменить токен аутентификации для отправки сообщений на сервис в ```sweater/__init__.py```
4. В консоли перейти в папку с репозиторием и выполнить команду ```docker-compose up``` (предварительно запустив docker).
5. После завершения скачивания образов, сборки и запуска контейнеров адрес http://127.0.0.1:5000/ начнет принимать запросы, можно использовать модуль requests python или использовать администраторский интерфейс (об администраторском интерфейсе и структуре запросов ниже).

### Адреса запросов и примерами структуры запроса к ним
* http://127.0.0.1:5000/api/contact - взаимодействует с таблицей contact (Клиент), принимает 4 метода запросов (GET, POST, PUT, DELETE)
    * GET - Отвечает информацией со всеми клиентами из базы данных.
    ```Python
    import requests
    requests.get("http://127.0.0.1:5000/api/contact")
    ```

    * POST - Отвечает информацией с id созданной записи. Принимает json с информацией о всех имеющихся в таблице столбах.
    ```Python
    import requests
    requests.post("http://127.0.0.1:5000/api/contact", json={"number":"+7917235678", "operator_code":"917", "tag":"tag1", "time_zone":"+2"})
    ```

    * PUT - Отвечает измененной записью клиента. Принимает json с id записи которую нужно изменить и названиями столбов с новой информацией. (Можно отправлять только столбцы с новой информацией, столбцы с данными которые изменяться не должны допускается не отправлять)
    ```Python
    import requests
    requests.put("http://127.0.0.1:5000/api/contact", json={"change": c_id, "tag": "tag1", "time_zone": "+6", "number":"+791723534"})
    requests.put("http://127.0.0.1:5000/api/contact", json={"change": c_id, "tag": "tag2"})
    ```

    * DELETE - Отвечает статусом. Принимает id записи которую нужно удалить.
    ```Python
    import requests
    requests.delete("http://127.0.0.1:5000/api/contact", json={"id": 2})
    ```
* http://127.0.0.1:5000/api/mailing - Взаимодействует с таблицей mailings (Рассылки), принимает 4 метода запросов (GET, POST, PUT, DELETE)
    * GET - Отвечает информацией со всеми рассылками из базы данных.
    ```Python
    import requests
    requests.get("http://127.0.0.1:5000/api/mailing")
    ```

    * POST - Отвечает информацией с id созданной записи. Принимает json с информацией о всех имеющихся в таблице столбах.
    ```Python
    import requests
    requests.post("http://127.0.0.1:5000/api/mailing", json={"start_time": "2022-12-10 17:00:00", "message": "Тестовое сообщение", "filters": "tag, tag2", "end_time": "2022-12-10 19:30:00"})
    ```

    * PUT - Отвечает измененной записью рассылки. Принимает json с id записи которую нужно изменить и названиями столбов с новой информацией. (Можно отправлять только столбцы с новой информацией, столбцы с данными которые изменяться не должны допускается не отправлять)
    ```Python
    import requests
    requests.put("http://127.0.0.1:5000/api/mailing", json={"change": 2, "filters": "tag, tag2, tag2"})
    ```

    * DELETE - Отвечает статусом. Принимает id записи которую нужно удалить.
    ```Python
    import requests
    requests.delete("http://127.0.0.1:5000/api/mailing", json={"id": 2})
    ```

* http://127.0.0.1:5000/api/messages - Взаимодействует с таблицей messages (Сообщения), принимает 4 метода запросов (GET, POST, PUT, DELETE)
    * GET (1 вариант) - Отвечает информацией со всеми сообщениями из базы данных. Принимает json с информацией о выборке
    ```Python
    import requests
    requests.get("http://127.0.0.1:5000/api/messages", json={"query": "all"})
    ```
    * GET (2 вариант) - Отвечает 1 записью. Принимает json с информацией [(id рассылки), (id контакта)]
    ```Python
    import requests
    requests.get("http://127.0.0.1:5000/api/messages", json={"query": [1, 3]})
    ```

    * POST - Отвечает информацией с id созданной записи. Принимает json с информацией о всех имеющихся в таблице столбах.
    ```Python
    import requests
    requests.post("http://127.0.0.1:5000/api/messages", json={"datetime": "2022-12-10 17:00:00", "status": "Обработка", "mailing_id": 1, "contact_id": 3})
    ```

    * PUT - Отвечает измененной записью сообщения. Принимает json с id записи которую нужно изменить и названиями столбов с новой информацией. (Можно отправлять только столбцы с новой информацией, столбцы с данными которые изменяться не должны допускается не отправлять)
    ```Python
    import requests
    requests.put("http://127.0.0.1:5000/api/messages", json={"change": 2, "status": "Не отправлено"})
    ```

    * DELETE - Отвечает статусом. Принимает id записи которую нужно удалить.
    ```Python
    import requests
    requests.delete("http://127.0.0.1:5000/api/mailing", json={"id": 2})
    ```

* http://127.0.0.1:5000/api/mailing/{id} - Адресс отвечает только на GET запрос. Отвечает детальной информацией о рассылке с отправленными по ней сообщениями. Принимает id рассылки в своем адресе.
```Python
import requests
requests.get("http://127.0.0.1:5000/api/mailing/2")
```

### Администраторский интерфейс
##### *(не имеет адаптивной верстки, разрабатывался под разрешение 1920х1080)*
Чтобы попасть в администраторский интерфейс перейдите по ссылке http://127.0.0.1:5000/. После вас перенаправит на страницу авторизации (по умолчанию Логин:Пароль - admin:admin). Также имеется возможность зарегистрировать нового пользователя. После авторизации откроется доступ к интерфейсу в котором можно перейти по любой вкладке и управлять информацией из базы данных.

### Выполненые дополнительные задания
*  Задание 1. Ответы, запросы, логика сервиса протестированы с помощью python unittest. В репозитории имеется файл test_api.py с помощью которого можно проводить повторные тестирования. Для запуска требуется .env (значение API_ADRESS), python dotenv. Консольная команда для запуска тестирования `python -m unittest -v -b test_api.py` (тестируется при запущенном сервисе).
* Задание 3. Сервисы запускаются и корректно работают на docker-compose.
* Задание 6. В администраторском интерфейсе можно получить и редактировать любую информацию базы данных
* Задание 7. Полноценную интеграцию реализовать не получилось из-за невозможности регистрации на OAuth2 в России, также сервис отслеживает местоположение и просто поставить другую страну не вышло. Поэтому я реализовал простенькую авторизацию на Flask с шифрованием/дешифрованием пароля.
* Задание 9. Удаленный сервис никак не влияет на стабильность работы сервиса рассылок. Сервис рассылок раз в минуту получает информацию о рассылках и если запрос не отправится он вернется к нему через n кол-во времени (если время окончания рассылки еще не истекло).
* Задание 12. В папке logs записываются все нужные логи по изменениям в таблице.

### Сервис отвечает преобразованными с помощью flask.jsonify() функцией. К сожалению функция некорректно преобразовывает данные в json так-как на выходе дает ответ в формате {'key': 'value'} и из-за одинарных ковычек не каждый язык сможет работать с таким ответом корректно и не подходит под определение OpenAPI.

### Языки и технологии
![Python](https://img.shields.io/badge/-Python-090909?style=for-the-badge&logo=python)
![Flask](https://img.shields.io/badge/-Flask-090909?style=for-the-badge&logo=flask)
![Docker](https://img.shields.io/badge/-Docker-090909?style=for-the-badge&logo=Docker)
![Postgres](https://img.shields.io/badge/-Postgres-090909?style=for-the-badge&logo=Postgresql)
![Sql-alchemy](https://img.shields.io/badge/-SQLAlchemy-090909?style=for-the-badge&logo=)